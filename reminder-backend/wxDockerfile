# 微信云托管专用 Dockerfile
# 针对 Jenkins 构建流程优化
FROM docker-0.unsee.tech/openjdk:8-jre-slim

# 设置工作目录
WORKDIR /app

# 创建日志目录
RUN mkdir -p /var/log/reminder

# 创建非root用户运行应用（安全最佳实践）
RUN groupadd -r spring && useradd -r -g spring spring

# 复制 JAR 文件 - 尝试多种可能的路径
# 方案1：直接指定文件名（最常见）
COPY reminder-core/target/reminder-core-0.0.1-SNAPSHOT.jar app.jar

# 更改文件所有者为新创建的非 root 用户
# 这一步必须在 COPY 之后，确保 app.jar 的权限也正确
RUN chown -R spring:spring /app /var/log/reminder

# 切换到非root用户
USER spring

# 暴露应用端口
EXPOSE 8080

# 设置JVM参数优化
ENV JAVA_OPTS="-Xms512m -Xmx1024m -Djava.security.egd=file:/dev/./urandom"

# 启动应用
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]