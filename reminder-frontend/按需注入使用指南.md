# 按需注入使用指南

## 概述

基于微信小程序按需注入理念，我们实现了一套完整的组件懒加载系统，可以显著提升应用的启动速度和运行性能。

## 核心概念

### 1. 按需注入
- 只加载当前页面需要的组件和资源
- 未使用的组件不会被打包到初始bundle中
- 组件在真正需要时才进行加载

### 2. 用时注入
- 组件在渲染时才进行注入
- 支持异步加载和错误处理
- 提供加载状态和占位内容

### 3. 占位组件
- 在组件加载期间显示占位内容
- 支持自定义加载样式
- 提供错误重试机制

## 使用方法

### 1. 基础用法

```javascript
// 在组件中使用按需注入
import { useFullCalendarPlugins } from '../utils/imports.js';

const loadComponents = async () => {
  const components = await useFullCalendarPlugins();
  // 使用加载的组件
};
```

### 2. 异步组件注册

```javascript
// 注册异步组件
import { createAsyncComponent } from '../utils/lazy-loader.js';

const AsyncCalendar = createAsyncComponent('CalendarDisplay', {
  loadingText: '正在加载日历...',
  delay: 200,
  timeout: 10000
});

app.component('AsyncCalendar', AsyncCalendar);
```

### 3. 页面组件配置

```javascript
// 在 lazy-loader.js 中配置页面组件依赖
export const pageComponentsConfig = {
  'CreateReminder': [
    'ReminderModal',
    'DateTimePicker',
    'ConfirmDialog'
  ]
};
```

### 4. 资源管理器

```javascript
// 使用资源管理器
import { resourceManager } from '../utils/imports.js';

// 加载单个资源
const cronParser = await resourceManager.load('cronParser');

// 批量加载资源
const [fullcalendar, daygrid] = await resourceManager.loadMultiple([
  'fullcalendar', 
  'daygrid'
]);

// 预加载资源
await resourceManager.preload(['fullcalendar', 'daygrid']);
```

## 配置选项

### 1. 组件映射配置

```javascript
export const componentMap = {
  'CalendarDisplay': () => import('../components/CalendarDisplay.vue'),
  'EventModal': () => import('../components/EventModal.vue'),
  // ... 更多组件
};
```

### 2. 页面依赖配置

```javascript
export const pageComponentsConfig = {
  'App': [
    'CalendarDisplay',
    'EventModal',
    'NotificationToast'
  ],
  // ... 更多页面
};
```

### 3. 插件配置

```javascript
app.use(LazyLoader, {
  preload: [
    'CalendarDisplay',  // 预加载的关键组件
    'NotificationToast'
  ]
});
```

## 最佳实践

### 1. 组件分类
- **关键组件**: 应用启动时必需的组件，可以预加载
- **功能组件**: 特定功能需要的组件，按需加载
- **第三方组件**: 大型第三方库，延迟加载

### 2. 加载策略
- **立即加载**: 用户交互前就开始加载
- **懒加载**: 用户触发时才开始加载
- **预加载**: 在空闲时间预先加载

### 3. 错误处理
- 提供加载失败的重试机制
- 显示友好的错误提示
- 记录加载失败的日志

### 4. 性能优化
- 合理配置组件依赖关系
- 避免重复加载相同组件
- 使用缓存机制提升加载速度

## 监控和调试

### 1. 加载状态监控

```javascript
// 检查组件是否已加载
const isLoaded = this.$isComponentLoaded('CalendarDisplay');

// 检查组件是否正在加载
const isLoading = this.$isComponentLoading('CalendarDisplay');

// 获取已加载的组件列表
const loadedComponents = this.$getLoadedComponents();
```

### 2. 开发环境调试

```javascript
// 清除组件缓存（仅开发环境）
if (process.env.NODE_ENV === 'development') {
  this.$clearComponentCache();
}
```

### 3. 控制台日志

系统会自动输出详细的加载日志：
- 🔄 开始加载组件
- ✅ 组件加载成功
- ❌ 组件加载失败
- 🚀 预加载开始
- 🧹 缓存清除

## 性能收益

### 1. 启动速度提升
- 减少初始bundle大小
- 降低首屏加载时间
- 提升用户体验

### 2. 内存使用优化
- 按需加载减少内存占用
- 避免加载不必要的代码
- 提升应用运行效率

### 3. 网络传输优化
- 代码分割减少传输量
- 并行加载提升效率
- 缓存机制减少重复请求

## 注意事项

1. **组件依赖**: 确保正确配置组件间的依赖关系
2. **加载顺序**: 注意组件的加载顺序，避免循环依赖
3. **错误处理**: 必须处理组件加载失败的情况
4. **兼容性**: 确保在不同环境下的兼容性
5. **测试**: 充分测试异步加载的各种场景

## 示例代码

完整的组件使用示例：

```vue
<template>
  <div class="page-container">
    <!-- 组件加载状态 -->
    <div v-if="!componentsLoaded" class="component-loading">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-text">正在加载组件...</div>
      </div>
    </div>
    
    <!-- 异步组件 -->
    <component
      v-if="componentsLoaded && CalendarComponent"
      :is="CalendarComponent"
      v-bind="calendarProps"
    />
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { useFullCalendarPlugins } from '../utils/imports.js';

const CalendarComponent = ref(null);
const componentsLoaded = ref(false);

const loadComponents = async () => {
  try {
    const components = await useFullCalendarPlugins();
    CalendarComponent.value = components.FullCalendar;
    componentsLoaded.value = true;
  } catch (error) {
    console.error('组件加载失败:', error);
  }
};

onMounted(() => {
  loadComponents();
});
</script>
```

通过这套按需注入系统，我们可以实现：
- 🚀 更快的应用启动速度
- 📦 更小的初始包体积
- 💾 更优的内存使用
- 🔄 更好的用户体验 