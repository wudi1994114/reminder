# 认证系统使用指南

## 概述

本项目实现了完整的用户认证系统，确保只有登录用户才能访问应用的核心功能。系统具有以下特点：

- **自动认证检查**: 应用启动时自动检查用户登录状态
- **智能跳转**: 未登录用户自动显示登录页面
- **Token管理**: 自动处理token过期和刷新
- **友好提示**: 提供清晰的用户反馈和错误提示
- **安全保护**: 防止未授权访问敏感功能

## 核心功能

### 1. 应用启动认证检查

当用户访问应用时，系统会自动执行以下检查：

```javascript
// 检查本地存储的token
const token = localStorage.getItem('accessToken');

if (token) {
  // 验证token有效性
  const userInfo = await fetchUserProfile();
  if (userInfo) {
    // 登录成功，显示主应用界面
    showMainApp();
  } else {
    // Token无效，显示登录页面
    showLoginPage();
  }
} else {
  // 无token，显示登录页面
  showLoginPage();
}
```

### 2. 登录状态管理

系统使用响应式状态管理用户登录状态：

```javascript
// 登录状态
const isLoggedIn = ref(false);
const currentUserProfile = ref(null);
const isAppInitialized = ref(false);

// 模板中的条件渲染
<template>
  <!-- 应用初始化加载 -->
  <div v-if="!isAppInitialized" class="app-loading">
    正在初始化应用...
  </div>
  
  <!-- 未登录 - 显示登录页面 -->
  <div v-else-if="!isLoggedIn" class="auth-container">
    <LoginView @login-attempt="handleLogin" />
  </div>
  
  <!-- 已登录 - 显示主应用 -->
  <template v-else>
    <MainApp :user="currentUserProfile" />
  </template>
</template>
```

### 3. 自动Token过期处理

系统会自动检测和处理token过期：

```javascript
// API响应拦截器
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // Token过期，自动退出登录
      handleLogout();
      showNotification('登录已过期，请重新登录', 'warning');
    }
    return Promise.reject(error);
  }
);
```

### 4. 认证守卫

提供认证守卫工具，保护需要登录的功能：

```javascript
import { requireAuth } from './utils/auth-guard.js';

// 保护需要登录的操作
function createReminder() {
  requireAuth(() => {
    // 已登录，执行创建提醒
    showCreateReminderModal();
  }, () => {
    // 未登录，显示提示
    showNotification('请先登录以创建提醒', 'warning');
  });
}
```

## 用户体验流程

### 1. 首次访问

```
用户访问应用
    ↓
检查本地token
    ↓
无token或token无效
    ↓
显示登录页面
    ↓
提示："请登录以使用提醒功能"
```

### 2. 登录成功

```
用户输入凭据
    ↓
发送登录请求
    ↓
服务器验证成功
    ↓
保存token到本地
    ↓
获取用户信息
    ↓
显示主应用界面
    ↓
提示："欢迎回来，[用户名]！"
```

### 3. Token过期

```
用户操作触发API请求
    ↓
服务器返回401错误
    ↓
自动清除过期token
    ↓
显示登录页面
    ↓
提示："登录已过期，请重新登录"
```

## 配置选项

### 1. 认证检查配置

```javascript
// 在checkAuthStatus函数中配置
const authConfig = {
  // 是否在首次访问时显示欢迎提示
  showWelcomeMessage: true,
  
  // 新用户提示延迟时间（毫秒）
  newUserTipDelay: 1000,
  
  // 是否自动刷新过期token
  autoRefreshToken: false
};
```

### 2. 错误处理配置

```javascript
// 在API拦截器中配置
const errorConfig = {
  // 认证错误后的跳转延迟
  authErrorDelay: 1500,
  
  // 是否显示详细错误信息
  showDetailedErrors: true,
  
  // 网络错误重试次数
  networkRetryCount: 3
};
```

## API接口

### 1. 登录接口

```javascript
// POST /api/auth/login
{
  "username": "user@example.com",
  "password": "password123"
}

// 响应
{
  "data": {
    "accessToken": "Bearer eyJhbGciOiJIUzI1NiIs...",
    "user": {
      "id": 1,
      "username": "user@example.com",
      "nickname": "用户昵称"
    }
  }
}
```

### 2. 用户信息接口

```javascript
// GET /api/auth/profile
// Headers: Authorization: Bearer token

// 响应
{
  "data": {
    "id": 1,
    "username": "user@example.com",
    "nickname": "用户昵称",
    "email": "user@example.com"
  }
}
```

## 错误处理

### 1. 网络错误

```javascript
// 网络连接失败
if (!error.response) {
  showNotification('网络连接失败，请检查网络设置', 'error');
}
```

### 2. 认证错误

```javascript
// 401 - 未授权
if (status === 401) {
  showNotification('登录已过期，请重新登录', 'warning');
}

// 403 - 权限不足
if (status === 403) {
  showNotification('访问权限不足，请重新登录', 'warning');
}
```

### 3. 服务器错误

```javascript
// 5xx - 服务器错误
if (status >= 500) {
  showNotification('服务器暂时不可用，请稍后重试', 'error');
}
```

## 安全考虑

### 1. Token存储

- Token存储在localStorage中
- 自动添加Bearer前缀
- 过期时自动清除

### 2. 请求安全

- 所有API请求自动携带token
- 自动处理认证失败
- 防止未授权访问

### 3. 状态管理

- 响应式状态管理
- 自动同步登录状态
- 防止状态不一致

## 开发调试

### 1. 控制台日志

系统提供详细的控制台日志：

```
App.vue: 开始检查用户认证状态...
检查本地存储的token: 存在
发现token，验证格式并尝试获取用户信息...
用户认证成功，用户信息: {id: 1, username: "user"}
认证检查完成，当前登录状态: true
```

### 2. 状态监控

```javascript
// 监控登录状态变化
watch(() => isLoggedIn.value, (newValue) => {
  console.log('登录状态变化:', newValue);
});

// 监控用户信息变化
watch(() => currentUserProfile.value, (newValue) => {
  console.log('用户信息变化:', newValue);
});
```

### 3. 手动测试

```javascript
// 在浏览器控制台中测试
// 清除登录状态
localStorage.removeItem('accessToken');
location.reload();

// 模拟token过期
localStorage.setItem('accessToken', 'invalid-token');
// 然后尝试任何API操作
```

## 最佳实践

### 1. 用户体验

- 提供清晰的加载状态
- 显示友好的错误提示
- 自动处理认证流程
- 保持状态一致性

### 2. 安全性

- 及时清除过期token
- 验证所有API响应
- 防止未授权访问
- 记录安全事件

### 3. 性能优化

- 避免重复认证检查
- 缓存用户信息
- 优化API请求
- 减少不必要的重新渲染

## 故障排除

### 1. 登录失败

**问题**: 用户无法登录
**解决方案**:
1. 检查网络连接
2. 验证用户凭据
3. 查看控制台错误
4. 检查API服务状态

### 2. Token过期

**问题**: 频繁要求重新登录
**解决方案**:
1. 检查token有效期设置
2. 实现token自动刷新
3. 优化token存储策略

### 3. 状态不一致

**问题**: 登录状态显示错误
**解决方案**:
1. 清除浏览器缓存
2. 检查状态管理逻辑
3. 验证API响应格式

通过这套完整的认证系统，我们确保了：
- ✅ 普通用户进入首页时，没有登录会自动显示登录页面
- ✅ 登录成功后自动显示主应用界面
- ✅ Token过期时自动退出并提示重新登录
- ✅ 提供友好的用户体验和错误处理
- ✅ 保护所有需要认证的功能 