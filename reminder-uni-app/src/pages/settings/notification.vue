<template>
  <view class="container">
    <view class="header-section">
      <view class="nav-container">
        <view class="nav-back" @click="goBack">
          <text class="back-icon">тА╣</text>
        </view>
        <view class="title-container">
          <text class="page-title">цПРщЖТшо╛ч╜о</text>
        </view>
        <view class="nav-spacer"></view>
      </view>
    </view>

    <!-- ф╕╗шжБхЖЕхо╣хМ║хЯЯ -->
    <scroll-view
      class="content-scroll"
      scroll-y
      :scroll-with-animation="true"
      :enable-back-to-top="true"
    >
      <view class="content-container">
        <!-- щАЪчФишо╛ч╜охИЖч▒╗ -->
        <view class="category-section">
          <view class="category-header">
            <view class="category-icon">
              <text class="icon-text">тЪЩя╕П</text>
            </view>
            <text class="category-title">щАЪчФи</text>
          </view>
          
          <view class="category-card">
            <!-- цаЗчн╛чобчРЖх╝АхЕ│ -->
            <view class="setting-item">
              <view class="item-content">
                <view class="item-icon">
                  <text class="icon-text">ЁЯП╖я╕П</text>
                </view>
                <view class="item-info">
                  <text class="item-label">цаЗчн╛чобчРЖ</text>
                  <text class="item-description">хРпчФишЗкхоЪф╣ЙцаЗчн╛хКЯшГ╜</text>
                </view>
              </view>
              <view class="item-switch">
                <switch
                  :checked="tagManagementEnabled"
                  @change="onTagManagementToggle"
                  color="#f7bd4a"
                />
              </view>
            </view>

            <!-- цаЗчн╛хИЧшбич╝Цш╛С -->
            <view v-if="tagManagementEnabled" class="tag-management-section">
              <view class="divider"></view>
              <view class="tag-editor">
                <view class="tag-editor-header">
                  <text class="tag-editor-title">цИСчЪДцаЗчн╛</text>
                  <text class="tag-count">{{ getTotalLength() }}/100</text>
                </view>

                <!-- цаЗчн╛хИЧшби -->
                <view class="tag-list">
                  <view
                    v-for="(tag, index) in userTags"
                    :key="index"
                    class="tag-item"
                  >
                    <view class="tag-content">
                      <text class="tag-text">{{ getTagTitle(tag) }}</text>
                    </view>
                    <view class="tag-remove" @click="removeTag(index)">
                      <text class="remove-icon">├Ч</text>
                    </view>
                  </view>

                  <!-- ц╖╗хКацаЗчн╛цМЙщТо -->
                  <view
                    v-if="getTotalLength() < 100"
                    class="tag-add"
                    @click="showAddTagDialog"
                  >
                    <text class="add-icon">+</text>
                  </view>
                </view>

                <!-- цаЗчн╛шп┤цШО -->
                <view class="tag-tips">
                  <text class="tip-text">тАв цаЗчн╛цА╗щХ┐х║жф╕Нш╢Еш┐З100ф╕кхнЧчмж</text>
                  <text class="tip-text">тАв цаЗчн╛чФиф║Ох┐лщАЯш╛УхЕех╕╕чФицПРщЖТхЖЕхо╣</text>
                </view>
              </view>
            </view>
          </view>
        </view>
        
        <!-- цПРщЖТшо╛ч╜охИЖч▒╗ -->
        <view class="category-section">
          <view class="category-header">
            <view class="category-icon">
              <text class="icon-text">ЁЯФФ</text>
            </view>
            <text class="category-title">цПРщЖТ</text>
          </view>
          
          <view class="category-card">
            <view class="setting-item" @click="navigateToReminderMethod">
              <view class="item-content">
                <view class="item-icon">
                  <text class="icon-text">ЁЯУ▒</text>
                </view>
                <view class="item-info">
                  <text class="item-label">цПРщЖТцЦ╣х╝П</text>
                  <text class="item-description">шо╛ч╜оцПРщЖТщАЪчЯецЦ╣х╝П</text>
                </view>
              </view>
              <view class="item-arrow">
                <text class="arrow-icon">тА║</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- х║ХщГищЧ┤ш╖Э -->
        <view class="bottom-spacer"></view>
      </view>
    </scroll-view>

    <!-- ц╖╗хКацаЗчн╛хп╣шпЭцбЖ -->
    <view v-if="showAddDialog" class="dialog-overlay" @click="hideAddTagDialog">
      <view class="dialog-container" @click.stop>
        <view class="dialog-header">
          <text class="dialog-title">ц╖╗хКацаЗчн╛</text>
        </view>
        <view class="dialog-content">
          <view class="input-wrapper">
            <view class="input-label">
              <text class="label-text">цаЗщвШ</text>
              <text class="required-mark">*</text>
            </view>
            <input
              v-model="newTagTitle"
              class="tag-input"
              placeholder="шп╖ш╛УхЕецаЗчн╛цаЗщвШ"
              maxlength="20"
              :focus="showAddDialog"
            />
          </view>
          
          <view class="input-wrapper">
            <view class="input-label">
              <text class="label-text">хЖЕхо╣</text>
            </view>
            <input
              v-model="newTagContent"
              class="tag-input"
              placeholder="шп╖ш╛УхЕецаЗчн╛хЖЕхо╣я╝ИхПпщАЙя╝Й"
              maxlength="50"
              @confirm="addTag"
            />
          </view>
          
          <view class="input-tips">
            <text class="tip-text">цаЗщвШчФиф║ОцШ╛чд║я╝МхЖЕхо╣чФиф║Ох┐лщАЯхблхЕецПРщЖТ</text>
          </view>
        </view>
        <view class="dialog-actions">
          <button class="dialog-btn cancel-btn" @click="hideAddTagDialog">хПЦц╢И</button>
          <button class="dialog-btn confirm-btn" @click="addTag">чбохоЪ</button>
        </view>
      </view>
    </view>
  </view>
</template>

<script>
import { ref, onMounted } from 'vue';
import {
  getUserTagManagementEnabled,
  setUserTagManagementEnabled,
  getUserTagList,
  setUserTagList
} from '@/services/api.js';

export default {
  name: 'NotificationSettings',
  setup() {
    // хУНх║Фх╝ПцХ░цНо
    const tagManagementEnabled = ref(false);
    const userTags = ref([]);
    const showAddDialog = ref(false);
    const newTagTitle = ref('');
    const newTagContent = ref('');
    const loading = ref(false);

    // щб╡щЭвхКаш╜╜цЧ╢шО╖хПЦчФицИ╖шо╛ч╜о
    onMounted(async () => {
      await loadUserSettings();
    });

    // хКаш╜╜чФицИ╖шо╛ч╜о
    const loadUserSettings = async () => {
      try {
        loading.value = true;

        // шО╖хПЦцаЗчн╛чобчРЖх╝АхЕ│чК╢цАБ
        try {
          const enabledResponse = await getUserTagManagementEnabled();
          tagManagementEnabled.value = enabledResponse.value === '1';
        } catch (error) {
          console.log('цаЗчн╛чобчРЖхКЯшГ╜цЬкхРпчФицИЦщжЦцмбф╜┐чФи');
          tagManagementEnabled.value = false;
        }

        // хжВцЮЬхРпчФиф║ЖцаЗчн╛чобчРЖя╝МшО╖хПЦцаЗчн╛хИЧшби
        if (tagManagementEnabled.value) {
          try {
            const tagsResponse = await getUserTagList();
            const tagListString = tagsResponse.value || '';
            userTags.value = tagListString ? tagListString.split('|-|').filter(tag => tag.trim()) : [];
          } catch (error) {
            console.log('шО╖хПЦцаЗчн╛хИЧшбихд▒ш┤ея╝Мф╜┐чФичй║хИЧшби');
            userTags.value = [];
          }
        }

      } catch (error) {
        console.error('хКаш╜╜чФицИ╖шо╛ч╜охд▒ш┤е:', error);
        uni.showToast({
          title: 'хКаш╜╜шо╛ч╜охд▒ш┤е',
          icon: 'none'
        });
      } finally {
        loading.value = false;
      }
    };

    // цаЗчн╛чобчРЖх╝АхЕ│хИЗцНв
    const onTagManagementToggle = async (event) => {
      const enabled = event.detail.value;

      try {
        await setUserTagManagementEnabled(enabled);
        tagManagementEnabled.value = enabled;

        if (enabled) {
          // хРпчФицЧ╢хКаш╜╜цаЗчн╛хИЧшби
          await loadUserSettings();
        } else {
          // чжБчФицЧ╢ц╕Ечй║цаЗчн╛хИЧшби
          userTags.value = [];
        }

        uni.showToast({
          title: enabled ? 'цаЗчн╛чобчРЖх╖▓хРпчФи' : 'цаЗчн╛чобчРЖх╖▓чжБчФи',
          icon: 'success'
        });

      } catch (error) {
        console.error('хИЗцНвцаЗчн╛чобчРЖчК╢цАБхд▒ш┤е:', error);
        uni.showToast({
          title: 'шо╛ч╜охд▒ш┤е',
          icon: 'none'
        });
      }
    };

    // шобчоЧцаЗчн╛хИЧшбицА╗щХ┐х║ж
    const getTotalLength = () => {
      return userTags.value.join('|-|').length;
    };

    // шО╖хПЦцаЗчн╛чЪДцаЗщвШщГихИЖчФиф║ОцШ╛чд║
    const getTagTitle = (tag) => {
      return tag.includes('|') ? tag.split('|')[0].trim() : tag;
    };

    // щкМшпБцаЗчн╛ца╝х╝П - ца╣цНохРОчлпщкМшпБшзДхИЩ
    const validateTag = (title, content) => {
      if (!title || !title.trim()) {
        return { valid: false, message: 'цаЗщвШф╕НшГ╜ф╕║чй║' };
      }

      const trimmedTitle = title.trim();
      const trimmedContent = content ? content.trim() : '';

      // цаЗщвШцШпх┐Ещб╗чЪД
      if (!trimmedTitle) {
        return { valid: false, message: 'цаЗщвШф╕НшГ╜ф╕║чй║' };
      }

      return { valid: true, message: 'ца╝х╝Пцнгчбо' };
    };

    // цШ╛чд║ц╖╗хКацаЗчн╛хп╣шпЭцбЖ
    const showAddTagDialog = () => {
      if (getTotalLength() >= 100) {
        uni.showToast({
          title: 'цаЗчн╛цА╗щХ┐х║жх╖▓ш╛╛хИ░100хнЧчмжщЩРхИ╢',
          icon: 'none'
        });
        return;
      }
      newTagTitle.value = '';
      newTagContent.value = '';
      showAddDialog.value = true;
    };

    // щЪРшЧПц╖╗хКацаЗчн╛хп╣шпЭцбЖ
    const hideAddTagDialog = () => {
      showAddDialog.value = false;
      newTagTitle.value = '';
      newTagContent.value = '';
    };

    // ц╖╗хКацаЗчн╛
    const addTag = async () => {
      const title = newTagTitle.value.trim();
      const content = newTagContent.value.trim();

      // хЯ║цЬмцгАцЯе
      if (!title) {
        uni.showToast({
          title: 'шп╖ш╛УхЕецаЗчн╛цаЗщвШ',
          icon: 'none',
          duration: 2000
        });
        return;
      }

      // цЮДх╗║хоМцХ┤цаЗчн╛я╝ИхРОхП░шЗкхКицЛ╝цОея╝Й
      const fullTag = content ? `${title}|${content}` : title;

              // цгАцЯещХ┐х║жщЩРхИ╢
        const currentLength = getTotalLength();
        const newTotalLength = currentLength + (currentLength > 0 ? 3 : 0) + fullTag.length; // +3цШп|-|хИЖщЪФчмж
      
      if (newTotalLength > 100) {
        uni.showToast({
          title: `ц╖╗хКацндцаЗчн╛х░Жш╢Еш┐З100хнЧчмжщЩРхИ╢я╝Их╜УхЙН${currentLength}я╝Мц╖╗хКахРО${newTotalLength}я╝Й`,
          icon: 'none',
          duration: 3000
        });
        return;
      }

      // цгАцЯецШпхРжщЗНхдНя╝ИхПкцгАцЯецаЗщвШщГихИЖя╝Й
      const existingTitles = userTags.value.map(tag => {
        return tag.includes('|') ? tag.split('|')[0].trim() : tag;
      });
      
      if (existingTitles.includes(title)) {
        uni.showToast({
          title: 'чЫ╕хРМцаЗщвШчЪДцаЗчн╛х╖▓хнШхЬи',
          icon: 'none',
          duration: 2000
        });
        return;
      }

      // щкМшпБцаЗчн╛ца╝х╝П
      const validation = validateTag(title, content);
      if (!validation.valid) {
        uni.showToast({
          title: validation.message,
          icon: 'none',
          duration: 3000
        });
        return;
      }

      try {
        // ц╖╗хКахИ░цЬмхЬ░хИЧшби
        const newTags = [...userTags.value, fullTag];

        // ф┐ЭхнШхИ░цЬНхКбхЩи
        await setUserTagList(newTags.join('|-|'));

        // цЫ┤цЦ░цЬмхЬ░чК╢цАБ
        userTags.value = newTags;

        // хЕ│щЧнхп╣шпЭцбЖ
        hideAddTagDialog();

        uni.showToast({
          title: 'цаЗчн╛ц╖╗хКацИРхКЯ',
          icon: 'success',
          duration: 1500
        });

      } catch (error) {
        console.error('ц╖╗хКацаЗчн╛хд▒ш┤е:', error);

        // ца╣цНощФЩшппч▒╗хЮЛцШ╛чд║ф╕НхРМчЪДцПРчд║
        let errorMessage = 'ц╖╗хКахд▒ш┤е';
        if (error.message && error.message.includes('щкМшпБхд▒ш┤е')) {
          errorMessage = 'цаЗчн╛ца╝х╝Пф╕Нцнгчбо';
        } else if (error.message && error.message.includes('ч╜Сч╗Ь')) {
          errorMessage = 'ч╜Сч╗ЬщФЩшппя╝Мшп╖щЗНшпХ';
        }

        uni.showToast({
          title: errorMessage,
          icon: 'none',
          duration: 2000
        });
      }
    };

    // хИащЩдцаЗчн╛
    const removeTag = async (index) => {
      try {
        // ф╗ОцЬмхЬ░хИЧшбиф╕нхИащЩд
        const newTags = userTags.value.filter((_, i) => i !== index);

        // ф┐ЭхнШхИ░цЬНхКбхЩи
        await setUserTagList(newTags.join('|-|'));

        // цЫ┤цЦ░цЬмхЬ░чК╢цАБ
        userTags.value = newTags;

        uni.showToast({
          title: 'цаЗчн╛хИащЩдцИРхКЯ',
          icon: 'success'
        });

      } catch (error) {
        console.error('хИащЩдцаЗчн╛хд▒ш┤е:', error);
        uni.showToast({
          title: 'хИащЩдхд▒ш┤е',
          icon: 'none'
        });
      }
    };

    const goBack = () => {
      uni.navigateBack({
        delta: 1
      });
    };

    const navigateToReminderMethod = () => {
      uni.showToast({
        title: 'цПРщЖТцЦ╣х╝ПхКЯшГ╜х╝АхПСф╕н',
        icon: 'none',
        duration: 2000
      });
    };

    return {
      // хУНх║Фх╝ПцХ░цНо
      tagManagementEnabled,
      userTags,
      showAddDialog,
      newTagTitle,
      newTagContent,
      loading,

      // цЦ╣ц│Х
      goBack,
      navigateToReminderMethod,
      onTagManagementToggle,
      getTotalLength,
      getTagTitle,
      showAddTagDialog,
      hideAddTagDialog,
      addTag,
      removeTag
    };
  }
};
</script>

<style scoped>
.container {
  height: 100vh;
  background-color: #fcfbf8;
  display: flex;
  flex-direction: column;
  font-family: 'Manrope', 'Noto Sans', sans-serif;
}

.header-section {
  background-color: #fcfbf8;
  padding: calc(var(--status-bar-height, 44rpx) + 80rpx) 32rpx 48rpx;
  flex-shrink: 0;
}

.nav-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 96rpx;
}

.nav-back {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 96rpx;
  height: 96rpx;
  cursor: pointer;
}

.back-icon {
  font-size: 48rpx;
  color: #1c170d;
  font-weight: 600;
}

.title-container {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
}

.page-title {
  font-size: 36rpx;
  font-weight: 700;
  color: #1c170d;
  text-align: center;
  line-height: 1.2;
  letter-spacing: -0.015em;
}

.nav-spacer {
  width: 96rpx;
  height: 96rpx;
}

/* хЖЕхо╣хМ║хЯЯ */
.content-scroll {
  flex: 1;
  overflow-y: auto;
  background-color: #fcfbf8;
}

.content-container {
  padding: 16rpx 32rpx 32rpx;
}

/* хИЖч▒╗хМ║хЯЯ */
.category-section {
  margin-bottom: 40rpx;
}

.category-header {
  display: flex;
  align-items: center;
  gap: 16rpx;
  margin-bottom: 16rpx;
  padding: 0 8rpx;
}

.category-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 56rpx;
  height: 56rpx;
  background-color: #f4efe7;
  border-radius: 16rpx;
  flex-shrink: 0;
}

.category-title {
  font-size: 32rpx;
  font-weight: 700;
  color: #1c170d;
  line-height: 1.2;
}

.category-card {
  background-color: #ffffff;
  border: 2rpx solid #f4efe7;
  border-radius: 24rpx;
  box-shadow: 0 6rpx 24rpx rgba(28, 23, 13, 0.08);
  overflow: hidden;
}

/* шо╛ч╜ощб╣ */
.setting-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 32rpx;
  transition: all 0.2s ease;
  cursor: pointer;
}

.setting-item:active {
  background-color: #fcfbf8;
}

.item-content {
  display: flex;
  align-items: center;
  gap: 24rpx;
  flex: 1;
}

.item-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 72rpx;
  height: 72rpx;
  background-color: #f4efe7;
  border-radius: 20rpx;
  flex-shrink: 0;
}

.icon-text {
  font-size: 36rpx;
}

.item-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8rpx;
}

.item-label {
  font-size: 32rpx;
  font-weight: 600;
  color: #1c170d;
  line-height: 1.2;
}

.item-description {
  font-size: 24rpx;
  color: #9d8148;
  line-height: 1.4;
}

.item-arrow {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 48rpx;
  height: 48rpx;
  flex-shrink: 0;
}

.arrow-icon {
  font-size: 48rpx;
  color: #cccccc;
  font-weight: 300;
}

.item-switch {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

/* цаЗчн╛чобчРЖхМ║хЯЯ */
.tag-management-section {
  padding: 0;
}

.divider {
  height: 1rpx;
  background-color: #f4efe7;
  margin: 0 32rpx;
}

.tag-editor {
  padding: 32rpx;
}

.tag-editor-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24rpx;
}

.tag-editor-title {
  font-size: 28rpx;
  font-weight: 600;
  color: #1c170d;
}

.tag-count {
  font-size: 24rpx;
  color: #9d8148;
}

.tag-list {
  display: flex;
  flex-wrap: wrap;
  gap: 16rpx;
  margin-bottom: 24rpx;
  min-height: 80rpx;
  align-items: flex-start;
  align-content: flex-start;
}

.tag-item {
  display: flex;
  align-items: center;
  background-color: #f7bd4a;
  border-radius: 20rpx;
  padding: 12rpx 16rpx;
  gap: 8rpx;
  max-width: 300rpx;
}

.tag-content {
  flex: 1;
  overflow: hidden;
}

.tag-text {
  font-size: 24rpx;
  color: #1c170d;
  font-weight: 500;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  display: block;
}



.tag-remove {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32rpx;
  height: 32rpx;
  background-color: rgba(28, 23, 13, 0.1);
  border-radius: 50%;
  flex-shrink: 0;
}

.remove-icon {
  font-size: 24rpx;
  color: #1c170d;
  font-weight: 600;
  line-height: 1;
}

.tag-add {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 80rpx;
  height: 56rpx;
  background-color: #f4efe7;
  border: 2rpx dashed #cccccc;
  border-radius: 20rpx;
  transition: all 0.2s ease;
}

.tag-add:active {
  background-color: #f7bd4a;
  border-color: #f7bd4a;
}

.add-icon {
  font-size: 32rpx;
  color: #9d8148;
  font-weight: 300;
}

.tag-tips {
  display: flex;
  flex-direction: column;
  gap: 8rpx;
}

.tip-text {
  font-size: 22rpx;
  color: #9d8148;
  line-height: 1.4;
}

/* хп╣шпЭцбЖца╖х╝П */
.dialog-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.dialog-container {
  background-color: #ffffff;
  border-radius: 24rpx;
  margin: 32rpx;
  max-width: 600rpx;
  width: 100%;
  box-shadow: 0 12rpx 48rpx rgba(0, 0, 0, 0.2);
}

.dialog-header {
  padding: 32rpx 32rpx 16rpx;
  border-bottom: 1rpx solid #f4efe7;
}

.dialog-title {
  font-size: 32rpx;
  font-weight: 700;
  color: #1c170d;
  text-align: center;
}

.dialog-content {
  padding: 32rpx;
}

.input-wrapper {
  margin-bottom: 24rpx;
}

.input-wrapper:last-of-type {
  margin-bottom: 16rpx;
}

.input-label {
  display: flex;
  align-items: center;
  margin-bottom: 8rpx;
  gap: 4rpx;
}

.label-text {
  font-size: 28rpx;
  color: #1c170d;
  font-weight: 500;
}

.required-mark {
  font-size: 28rpx;
  color: #ff4757;
  font-weight: 600;
}

.tag-input {
  width: 100%;
  height: 80rpx;
  background-color: #f4efe7;
  border: 2rpx solid #f4efe7;
  border-radius: 16rpx;
  padding: 0 24rpx;
  font-size: 28rpx;
  color: #1c170d;
  box-sizing: border-box;
}

.tag-input:focus {
  border-color: #f7bd4a;
  background-color: #ffffff;
}

.input-tips {
  margin-top: 8rpx;
}

.dialog-actions {
  display: flex;
  border-top: 1rpx solid #f4efe7;
}

.dialog-btn {
  flex: 1;
  height: 88rpx;
  background-color: transparent;
  border: none;
  font-size: 28rpx;
  font-weight: 600;
  border-radius: 0;
  margin: 0;
  padding: 0;
}

.cancel-btn {
  color: #9d8148;
  border-right: 1rpx solid #f4efe7;
}

.confirm-btn {
  color: #f7bd4a;
}

.dialog-btn:active {
  background-color: #f4efe7;
}

/* х║ХщГищЧ┤ш╖Э */
.bottom-spacer {
  height: 120rpx;
}

/* хУНх║Фх╝Пш░ГцХ┤ */
@media (max-width: 750rpx) {
  .header-section {
    padding: calc(var(--status-bar-height, 44rpx) + 64rpx) 24rpx 32rpx;
  }

  .nav-container {
    height: 80rpx;
  }

  .nav-back,
  .nav-spacer {
    width: 80rpx;
    height: 80rpx;
  }

  .back-icon {
    font-size: 40rpx;
  }

  .page-title {
    font-size: 32rpx;
  }

  .content-container {
    padding: 12rpx 24rpx 24rpx;
  }

  .setting-item {
    padding: 24rpx;
  }

  .item-icon {
    width: 64rpx;
    height: 64rpx;
  }

  .icon-text {
    font-size: 32rpx;
  }

  .item-label {
    font-size: 28rpx;
  }

  .item-description {
    font-size: 22rpx;
  }
}
</style>